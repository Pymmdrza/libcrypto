name: Test and Build LibCrypto

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]
    workflow_dispatch:

jobs:
    test:
        name: Test on Python ${{ matrix.python-version }}
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                python-version: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13"]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install setuptools wheel
                  pip install pytest pytest-cov
                  pip install -r requirements.txt

            - name: Install package in development mode
              run: |
                  pip install -e .

            - name: Run verification script
              run: |
                  # Use the project's verification script which knows how to
                  # differentiate internal 'cryptod' vs external pycryptodome.
                  python verify_no_deps.py

            - name: Run tests with pytest
              run: |
                  pytest tests/ -v --tb=short

            - name: Run tests with coverage
              if: matrix.python-version == '3.12'
              run: |
                  pytest tests/ -v --cov=libcrypto --cov-report=term-missing --cov-report=xml

            - name: Upload coverage to Codecov
              if: matrix.python-version == '3.12'
              uses: codecov/codecov-action@v4
              with:
                  file: ./coverage.xml
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false

    lint:
        name: Lint and Code Quality
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python 3.12
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install flake8

            - name: Lint with flake8
              run: |
                  # Stop the build if there are Python syntax errors or undefined names
                  flake8 src/libcrypto --count --select=E9,F63,F7,F82 --show-source --statistics
                  # Exit-zero treats all errors as warnings
                  flake8 src/libcrypto --count --exit-zero --max-complexity=12 --max-line-length=120 --statistics

            - name: Check formatting with black (optional)
              continue-on-error: true
              run: |
                  pip install black
                  black --check src/libcrypto

            - name: Check import sorting with isort (optional)
              continue-on-error: true
              run: |
                  pip install isort
                  isort --check-only src/libcrypto

    build:
        name: Build Distribution
        runs-on: ubuntu-latest
        needs: [test, lint]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python 3.12
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"

            - name: Install build dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install build twine

            - name: Build package
              run: |
                  python -m build

            - name: Check distribution
              run: |
                  twine check dist/*

            - name: List distribution files
              run: |
                  ls -lh dist/

            - name: Upload distribution artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: python-package-distributions
                  path: dist/

    test-install:
        name: Test Installation
        runs-on: ${{ matrix.os }}
        needs: build
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                python-version: ["3.8", "3.12"]

        steps:
            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Download distribution artifacts
              uses: actions/download-artifact@v4
              with:
                  name: python-package-distributions
                  path: dist/

            - name: Install from wheel
              shell: bash
              run: |
                  pip install dist/*.whl

            - name: Test basic import
              run: |
                  python -c "import libcrypto; from libcrypto import PrivateKey, Wallet, generate_mnemonic; print('✅ LibCrypto imported successfully')"

            - name: Verify no external crypto dependencies
              run: |
                  python -c "import sys; import libcrypto; has_ecdsa = 'ecdsa' in sys.modules; has_crypto = 'Crypto' in sys.modules; is_internal = 'libcrypto' in str(getattr(sys.modules.get('Crypto'), '__file__', '')) if has_crypto else False; assert not has_ecdsa, 'ecdsa should not be loaded'; assert not has_crypto or is_internal, 'external pycryptodome should not be loaded'; print('✅ No external crypto dependencies')"

            - name: Test key generation
              run: |
                  python -c "from libcrypto import PrivateKey; pk = PrivateKey(1); print(f'Public key: {pk.get_public_key().hex[:32]}...'); print('✅ Key generation works')"
